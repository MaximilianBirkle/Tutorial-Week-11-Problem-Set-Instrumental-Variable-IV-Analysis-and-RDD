---
title: "Tutorial Week 11: Instrumental Variable (IV) Analysis and RDD"
author:
  - Maximilian Birkle
  - Daniel Lehmann
  - Henry Lucas
date: "`r Sys.Date()`"
output:
  pdf_document:
    toc: true
    number_sections: true
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    number_sections: true
    code_folding: show
    theme: flatly
    highlight: tango
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 6,
  cache = FALSE
)
```

# Setup and Package Loading

```{r load-packages}
# Install packages if needed
packages <- c("AER", "haven", "dplyr", "ggplot2", "stargazer",
              "boot", "lmtest", "sandwich", "knitr", "kableExtra",
              "rdrobust", "rddensity", "rdlocrand")

for (pkg in packages) {
  if (!require(pkg, character.only = TRUE)) {
    install.packages(pkg)
    library(pkg, character.only = TRUE)
  }
}
```

# Load Data

```{r load-data}
# Load the AJR (2001) replication data
ajr_data <- haven::read_dta("acemoglu.dta")
cat("Observations:", nrow(ajr_data), "\n")
cat("Variables:", ncol(ajr_data), "\n")
```

# Problem 1: Instrumental Variable Analysis

## Q3. Instrument Validity and Timing (10 pts)

### 3.1 Causal Priority in AJR's Theory

**Why settler mortality must be causally prior to institutions:**

[Write your answer here]

Key points to address:
- The logic of instrumental variables requires that Z → T → Y (no reverse causation)
- In AJR's theory, high settler mortality → extractive institutions → lower growth
- If institutions could affect mortality rates retroactively, the IV assumption fails
- The exclusion restriction requires mortality affects GDP ONLY through institutions

### 3.2 Timing Problems

**Issues with timing of settler mortality measurements:**

[Write your answer here]

Address each IV assumption:

**Relevance (First-stage):**
- Why does measurement timing affect the strength of the first stage?
- Consider data availability and measurement error

**Exclusion Restriction:**
- If mortality was measured long after colonization, what other channels might exist?
- Could later mortality reflect economic conditions rather than cause them?

**Independence:**
- Are there confounders that affect both late-measured mortality and outcomes?
- Geographic or climatic factors?

### 3.3 Assessment of AJR Results

Based on your analysis:

```{r ajr-assessment}

```

**Your assessment:**

[Write your answer here]

Consider:
- Is the first stage strong enough?
- Are the IV assumptions plausible given the timing issues?
- What are the main threats to validity?
- Would you believe the causal interpretation?

---

## Q4. Albouy's Critique of AJR (10 pts)

### Q4(a). Measurement Problems

**Key measurement issues raised by Albouy (2012):**

1. [Issue 1]:

2. [Issue 2]:

**Why they matter for IV validity:**

[Your answer]

### Q4(b). Violations of IV Assumptions

**Relevance:**

Albouy's argument:

[Your answer]

**Independence:**

Albouy's argument:

[Your answer]

**Exclusion Restriction:**

Albouy's argument:

[Your answer]

### Q4(c). Sensitivity and Data Corrections

After Albouy reconstructs and corrects the mortality data:

**Effects on:**

1. **First stage:** [Your answer - what happens to F-statistic and coefficient?]

2. **Reduced form:** [Your answer - does the relationship weaken?]

3. **2SLS estimates:** [Your answer - how do the causal estimates change?]

**What this reveals about stability:**

[Your answer - are the AJR findings robust or fragile?]

### Q4(d). Interpretation

**Do you believe the AJR conclusions still hold?**

[Your answer]

**Or do the methodological issues undermine the core causal claim?**

[Your answer]

**Justification:**

[Provide clear reasoning based on:
- The strength of Albouy's critique
- Your replication results
- The plausibility of IV assumptions
- The sensitivity of findings to data corrections]

---

# Problem 2: Regression Discontinuity Design

## Part A - Data Loading and Setup

```{r load-rd-data}
# Load RD data
data <- read.csv("CTV_2020_Sage.csv")

# Define outcome, running variable, and covariates
Y <- data$mv_incpartyfor1
X <- data$mv_incparty

covs <- data[, c("pibpc", "population", "numpar_candidates_eff",
                 "party_DEM_wonlag1_b1", "party_PSDB_wonlag1_b1",
                 "party_PT_wonlag1_b1", "party_PMDB_wonlag1_b1")]
covsnm <- c("GDP per capita", "Population", "No. Effective Parties",
            "DEM Victory t-1", "PSDB Victory t-1", "PT Victory t-1", "PMDB Victory t-1")

cat("RDD data loaded successfully!\n")
cat("Observations:", nrow(data), "\n")
cat("Running variable (X): Incumbent Party's Margin of Victory\n")
cat("Outcome variable (Y): Incumbent Party Victory at t+1\n")
```

---

## Part B - Falsification Analysis

### Density Test

```{r density-test}
# McCrary density test using rddensity
rddens <- rddensity(X)
summary(rddens)

# Plot the density
rdplotdensity(rddens, X = data$mv_incparty[!is.na(data$mv_incparty)],
              xlab = "Incumbent Party's Margin of Victory at t",
              ylab = "Estimated density")
```

**Interpretation:**

The density test checks whether there is evidence of manipulation around the threshold (margin of victory = 0). A significant discontinuity in the density would suggest that parties can manipulate their vote margins to barely win elections, which would violate the RD identifying assumptions.

---

### Covariate Balance Tests

```{r covariate-balance}
# Test for balance in covariates at the threshold
for(c in 1:ncol(covs)){
  cat("\n=== Testing covariate:", covsnm[c], "===\n")
  rdr_cov <- rdrobust(covs[,c], X)
  print(summary(rdr_cov))

  # Create RD plot for this covariate
  rdplot(covs[,c], X,
         y.label = covsnm[c],
         x.label = "Incumbent Party's Margin of Victory",
         x.lim = c(-30, 30),
         binselect = "qsmv")
}
```

**Interpretation:**

Covariate balance tests check whether pre-treatment characteristics are continuous at the threshold. If covariates jump discontinuously at the cutoff, this suggests the treatment is not "as-if" randomly assigned, which would undermine the validity of the RD design.

---

## Part C - Outcome Analysis

### RD Plot

```{r rd-plot}
# Create RD plot of outcome variable
rdplot(Y, X,
       y.label = "Incumbent Party Victory at t+1",
       x.label = "Incumbent Party's Margin of Victory at t")
```

---

### Continuity-Based RDD Analysis

```{r rd-analysis-continuity}
# Main RDD estimate without covariates
rdr <- rdrobust(Y, X)
summary(rdr)

cat("\n=== RDD ESTIMATE (without covariates) ===\n")
cat("Point estimate:", rdr$coef[1], "\n")
cat("Robust p-value:", rdr$pv[3], "\n")
cat("95% CI: [", rdr$ci[3,1], ",", rdr$ci[3,2], "]\n")
cat("\nBandwidth (left):", rdr$bws[1], "\n")
cat("Bandwidth (right):", rdr$bws[2], "\n")
cat("Effective N (left):", rdr$N_h[1], "\n")
cat("Effective N (right):", rdr$N_h[2], "\n")
```

---

### RDD Analysis with Covariates

```{r rd-analysis-covariates}
# RDD estimate with covariates
rdrcovs <- rdrobust(Y, X, covs = covs)
summary(rdrcovs)

cat("\n=== RDD ESTIMATE (with covariates) ===\n")
cat("Point estimate:", rdrcovs$coef[1], "\n")
cat("Robust p-value:", rdrcovs$pv[3], "\n")
cat("95% CI: [", rdrcovs$ci[3,1], ",", rdrcovs$ci[3,2], "]\n")
cat("\nBandwidth (left):", rdrcovs$bws[1], "\n")
cat("Bandwidth (right):", rdrcovs$bws[2], "\n")
cat("Effective N (left):", rdrcovs$N_h[1], "\n")
cat("Effective N (right):", rdrcovs$N_h[2], "\n")
```

**Interpretation:**

The RDD estimates show the causal effect of barely winning an election (vs. barely losing) on the probability of the incumbent party winning the next election. This tests the "incumbency curse" hypothesis - that winning may actually hurt a party's chances in the next election due to weak parties and term limits in Brazilian municipalities.

Compare the estimates with and without covariates. If they are similar, this provides additional evidence that the RD design is valid (covariates should not matter much if treatment is as-if random near the threshold).

---

## Part D - Local Randomization Approach

```{r rd-local-random}
# Window selection for local randomization
rdwin <- rdwinselect(X, covs, wmin = 0.05, wstep = 0.01, nwindows = 200,
                     seed = 765, plot = TRUE, quietly = TRUE)

# Use selected window (or manually choose)
w <- 0.15

# Randomization inference
rdrand <- rdrandinf(Y, X, wl = -w, wr = w, reps = 1000, seed = 765)
summary(rdrand)

cat("\n=== LOCAL RANDOMIZATION INFERENCE ===\n")
cat("Window: [", -w, ",", w, "]\n")
cat("Treatment effect:", rdrand$obs.stat, "\n")
cat("P-value:", rdrand$p.value, "\n")
```

**Interpretation:**

The local randomization approach assumes that units very close to the threshold (within a narrow window) are essentially randomly assigned to treatment. This provides an alternative inference method that doesn't rely on asymptotic approximations and may be more appropriate with discrete running variables.

---

## Part E - Assessment

**Key Findings:**

1. **Density Test:** [Interpret whether there is evidence of manipulation]

2. **Covariate Balance:** [Summarize whether covariates are balanced]

3. **RDD Estimates:** [State the main findings about the incumbency effect]

4. **Robustness:** [Assess whether estimates are stable across specifications]

**Overall Validity:**

[Your assessment of whether the RDD design is credible in this context and whether the findings support the "incumbency curse" hypothesis]

---

# References

Acemoglu, D., Johnson, S., & Robinson, J. A. (2001). The Colonial Origins of Comparative Development: An Empirical Investigation. *American Economic Review*, 91(5), 1369–1401.

Albouy, D. (2012). The Colonial Origins of Comparative Development: An Investigation of the Settler Mortality Data. *American Economic Review*, 102(6), 3059–3076.

Klašnja, M., & Titiunik, R. (2017). The Incumbency Curse: Weak Parties, Term Limits, and Unfulfilled Accountability. *American Political Science Review*, 111(1), 129-148.

---

# Session Information

```{r session-info}
sessionInfo()
```
